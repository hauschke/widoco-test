name: Generate Ontology Documentation

# Trigger manually or on release
on:
  workflow_dispatch:
  release:
    types: [published]

# Allow the workflow to push back to the repo
permissions:
  contents: write

jobs:
  widoco-docs:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Create required folders
      - name: Prepare folders
        run: |
          mkdir -p docs/dev
          mkdir -p docs/logs

      # 3. Cache Docker image
      - name: Cache WIDOCO Docker image
        uses: actions/cache@v3
        with:
          path: /tmp/widoco-image
          key: widoco-image-latest
          restore-keys: widoco-image-latest

      # 4. Run WIDOCO
      - name: Generate documentation with WIDOCO
        run: |
          echo "Starting WIDOCO..."
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            ghcr.io/dgarijo/widoco:v1.4.25 \
            -ontFile /workspace/vivo.owl \
            -outFolder /workspace/docs/dev \
            -lang en \
            -rewriteAll \
            -noPlaceHolderText \
            -includeImportedOntologies \
            -getOntologyMetadata \
            > /workspace/docs/logs/widoco.log 2>&1

      # 5. Verify WIDOCO output
      - name: Verify documentation
        run: |
          TARGET="docs/dev/index-en.html"
          echo "===== WIDOCO LOG ====="
          cat docs/logs/widoco.log
          echo "===== Check target ====="
          if [ ! -f "$TARGET" ]; then
            echo "ERROR: documentation not found"
            ls -R docs
            exit 1
          else
            echo "Documentation generated successfully: $TARGET"
          fi

      # 6. Commit and push generated docs
      - name: Commit generated documentation
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Generate ontology documentation (dev)
          file_pattern: docs/**
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
