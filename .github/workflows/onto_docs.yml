name: Generate VIVO Ontology Documentation (WIDOCO)

permissions:
  contents: write

on:
  push:
    branches: [ main ]
    paths:
      - vivo.owl
      - .github/workflows/ontology-docs.yml
  workflow_dispatch:

jobs:
  widoco:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare docs directory
        run: |
          rm -rf docs
          mkdir -p docs

      - name: Run WIDOCO (VIVO‑tuned, single language, single page)
        run: |
          docker run \
            --name widoco_run \
            -e JAVA_TOOL_OPTIONS="-Xmx6G -Djava.io.tmpdir=/tmp" \
            -v "$PWD/vivo.owl:/input/vivo.owl:ro" \
            ghcr.io/dgarijo/widoco:latest \
            sh -c "
              mkdir -p /tmp/output && \
              widoco \
                -ontFile /input/vivo.owl \
                -outFolder /tmp/output \
                -lang en \
                -rewriteAll \
                -webVowl \
                -noSection \
                -noPlaceHolderText \
                -uniteSections
            "

      - name: Copy documentation from container
        run: |
          docker cp widoco_run:/tmp/output/. docs

      - name: Cleanup container
        run: |
          docker rm widoco_run

      - name: Normalize index page for GitHub Pages
        run: |
          # Ensure GitHub Pages root works
          if [ -f docs/index-en.html ]; then
            mv docs/index-en.html docs/index.html
          fi

          # Disable Jekyll
          touch docs/.nojekyll

      - name: Add GitHub Pages TOC and navigation
        run: |
          cat <<'EOF' > docs/README.md
          # VIVO Ontology Documentation

          ## Navigation
          - **Ontology Overview** → [Index](index.html)
          - **Classes and properties** → [Cross Reference](sections/crossref-en.html)
          - **Graph Visualization (WebVOWL)** → [WebVOWL](webvowl/index.html)
          - **Provenance** → [Provenance](sections/provenance-en.html)

          ---
          Generated automatically using **WIDOCO**.
          EOF

      - name: Commit and push documentation
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add docs
          if git diff --cached --quiet; then
            echo "No documentation changes to commit."
          else
            git commit -m "Update VIVO ontology documentation (WIDOCO)"
            git push
          fi
